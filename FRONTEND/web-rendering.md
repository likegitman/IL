# Web Rendering

## 1. DOM 트리 구축
첫 단계는 HTML을 처리하여 DOM 트리를 만드는 것이다. HTML 구문 분석은 토큰화와 트리 생성을 포함한다.

HTML 토큰은 시작 및 종료 태그 그리고 속성 이름 및 값을 포함한다. 문서가 잘 구성 되어있다면 이 시간은 더 빨라진다.

DOM 트리는 문서의 내용을 설명한다. html은 DOM 트리의 root 노드이다. 가장 최상단에 위치해 있고 트리는

다른 태그간의 관계와 계층을 반영한다. DOM 노드의 개수가 많아질수록 DOM 트리를 만드는 데 더 오랜 시간이 걸린다.

![image](https://github.com/likegitman/TIL/assets/105215297/990b6f25-2825-4c75-91a2-495d61549f1a)
[출처](https://developer.mozilla.org/ko/docs/Web/Performance/How_browsers_work#cssom_%EA%B5%AC%EC%B6%95building_the_cssom)

구문 분석기가 이미지와 같은 none blocking 자원을 발견하면 브라우저는 해당 자원을 요청하고 분석을 계속한다.

구문 분석은 CSS 파일을 만났을 때는 지속되지만 async, defer 같은 설정이 되어있지 않은 <scripts>는 렌더링을 막고

HTML의 분석을 중지시킨다. 그래서 과도한 script는 렌더링 속도를 느리게 할 수 있다.

### 프리로드 스캐너
브라우저가 DOM 트리를 만드는 과정은 js의 메인 스레드를 차지하는데 프리로드 스캐너는 사용 가능한 컨텐츠를 분석하고

CSS, JavaScript, Web font 같이 우선순위가 높은 자원을 요청한다. 프리로드 스캐너가 뒤에서 자원을 미리 요청하기 때문에

외부 자원에 대한 참조를 찾아 요청하기까지 기다리지 않아도 되는 이점이 발생한다. 프리로드 스캐너가 제공하는 최적화는

blocking을 최대한 줄여주는 중요한 역할을 해준다.
```html
<link rel="stylesheet" src="styles.css" />
<script src="myscript.js" async></script>
<img src="myimage.jpg" alt="image description" />
<script src="anotherscript.js" async></script>
```
위 코드를 예로 들때 메인 스레드가 HTML, CSS를 분석할 때 프리로드 스캐너는 위 코드와 같은 scripts와 img를 찾아서

다운로드하기 시작한다. CSS를 다운로드하는 것은 HTML 분석, 다운로드를 방해하지 않지만 JavaScript의 실행은 막는다.

js를 막는 이유는 js에는 종종 요소에 영향을 주는 CSS 속성들을 조작하기 때문이다.

## 2. CSSOM 구축
위에서 DOM 트리를 생성했다면 이제 CSS를 처리하고 CSSOM 트리를 만들어야한다. CSS 객체 모델은 DOM과 똑같이 트리구조이다.

하지만 둘은 독립적인 자료구조이고 브라우저는 CSS 규칙을 이해하고 작업을 진행할 수 있도록 스타일 맵으로 변환한다.

CSS 선택기에 기반하여 부모, 자식, 형제 관계의 노드를 구성한다. HTML과 같이 브라우저는 전송받은 CSS 규칙을 작업 가능한 

상태로 변환해야하는데 따라서 브라우저는 HTML을 객체로 바꾼 과정을 CSS에 더해서 다시 한 번 해야한다.

CSSOM이 만들어지는 것은 매우 빠르고 CSSOM을 만드는 데에 드는 시간은 일반적으로 한 번의 DNS 조회를 하는 시간보다

짧기에 웹 성능 최적화의 관점에서 CSSOM은 성능 향상에 큰 기여를 할 수 있는 영역은 아니다.

### JavaScript 컴파일
CSSOM이 생성되는 동안 프리로드 스캐너 덕분에 js 파일같은 다른 자원도 다운로드된다. 일부 브라우저 엔진은

추상 구문 트리를 인터프리터에게 넘긴다. 그 결과 메인 스레드에서 실행되는 바이트코드가 생성되고 이것이 js 컴파일 과정이다.

### 접근성 트리 구축
브라우저는 접근성 트리라는 것을 만든다. 보조 장치는 이 트리를 이용해 내용을 분석하고 해석한다. 

접근성 객체 모델은 AOM이라고 부른다. 브라우저는 DOM이 업데이트 될 때 접근성 트리도 업데이트한다.

접근성 객체 모델이 만들어지기 전까지 스크린 리더기는 컨텐츠에 접근할 수 없다.

#### 스크린 리더기
컴퓨터나 모바일 화면의 텍스트를 TTS를 통해 읽어주는 소프트웨어. 일반적으로 시각장애인이 이를 이용해 눈으로 보는 대신

소리로 들으면서 화면에 담긴 정보를 이해하는데 사용한다. 웹에서 웹 표준을 다룰 때 많이 거론되며 웹사이트가 접근성을

잘 지키는가를 평가하는 가장 큰 척도 중 하나가 스크린 리더로 읽힐 때 올바른 내용을 제공하는가이다.

예시로 alt가 없는 이미지가 도배된 사이트라면 스크린 리더를 사용하는 시각장애인들에게는 무슨 내용인지 알 방법이 없다.


## 3. 렌더
렌더링 과정에는 style, layout, paint가 포함된다. DOM과 CSSOM 트리는 구문 분석되는 과정에서 생성되고 렌더 트리로 합성된다.

렌더 트리는 보이는 요소의 레이아웃을 계산하고나서 화면에 paint 된다. 화면의 일부분을 CPU가 아니라 GPU가 그리면서

메인 스레드의 부담이 줄고 성능이 향상된다.

### Style
중요한 렌더링 경로에서 세 번째 단계는 DOM과 CSSOM을 합쳐 렌더트리를 만드는 것이다. 계산된 스타일 트리(렌더 트리)는

DOM 트리의 root부터 시작하여 눈에 보이는 노드를 순회하며 만들어진다. <head>와 그 자식 요소 혹은 사용자 정의 스타일 시트에

정의되어있는 `script { display: none; }`처럼 화면에 나타나지 않는 태그의 경우엔 렌더링 결과에 나타나지 않기 때문에

렌더 트리에 포함되지 않는다. `visibility: hidden` 속성을 가진 요소는 자리를 차지하기 때문에 렌더 트리에 포함된다.

각각 보이는 노드들은 그 노드에 적용된 CSSOM 규칙이 있다. 렌더 트리가 보이는 모든 노드의 내용과 계산된 스타일을 가지고 있다.

DOM 트리에서 보이는 모든 노드에 관련된 스타일을 모두 맞춰보고 CSS cascading 방식에 따라서 각 노드의 계산된 스타일이

무엇인지 경정하게 된다.

### Layout
중요한 렌더링 과정에서 네 번째 단계는 만들어진 렌더 트리를 기반으로 각 노드의 도형값을 계산하기 위해 layout을 실행시키는 것이다.

layout은 렌더 트리에 있는 모든 너비, 높이, 위치를 결정하는 과정이다. 렌더 트리가 한 번 만들어지고 나면 layout이 시작된다.

렌더 트리는 보이지 않더라도 계산된 스타일과 함께 어떤 노드가 화면에 표시될 지 식별한다. 하지만 각 노드의 위치나 좌표를 알지는 못한다.

각 객체의 정확한 크기와 위치를 결정하기 위해 브라우저는 렌더 트리의 root부터 시작하여 트리를 순회한다.

웹 페이지에서 대부분은 박스 형태인데 다른 기기, 데스크탑 설정은 제한 없이 매우 다양한 뷰 포트 크기를 가진다.

layout 단계에서 이 viewport의 크기를 고려한다. 브라우저는 화면에 표시될 모든 다른 상자들의 크기를 결정한다.

viewport의 크기를 기본으로하며 layoutㅇ느 일반적으로 본문에서 시작해 모든 자식의 크기를 각 요소의 박스 모델 속성을 통해 계산한다.

이미지같이 크기를 모르는 요소들은 위치 표시 공간을 남겨둔다. 

정리하면 처음 노드의 크기와 위치가 결정되는 것을 layout이라고 부른다.

### Paint
렌더링에서 마지막 단계는 각 노드를 화면에 pating하는 것이다. painting이 처음 일어나는 것을 FMP라고 부른다.

FMP는 First Meaningful Paint 최초 의미있는 페인트라는 뜻이다. painting 또는 레지스터화 단계에서 브라우저는

layout 단계에서 계산된 각 박스를 실제 화면의 px로 변환된다. painting에서 텍스트, 색깔 경계, 그림자 및 버튼, 이미지 등의

대체 요소를 포함하여 모든 요소의 시각적인 부분을 화면에 그리는 작업이 포함된다. 브라우저는 이 작업을 매우 빠르게 해야한다.

부드러운 스크롤이나 애니메이션을 위해 style 계산, reflow, painting 같이 메인 스레드를 점유하는 모든 작업은 브라우저를

`16.67ms` 미만만 차지해야한다. 2048 x 1536 화면에서 iPad는 화면에 paint 하려면 3,145,000px을 가지고 있어야한다.

한 눈에 봐도 아주 많은 양인걸 알 수 있고 이 px은 아주 빠르게 브라우저에 페인팅 되어야한다. 그러기 위해서 화면에 그리는 작업은

일반적으로 몇 개의 레이어로 구분되는데 그러면 합성이라는 작업도 필요하다.

#### 합성
문서의 각 section이 다른 layer에서 그려질 때 section을 겹쳐놓으면서 그것들이 올바른 순서로 화면에 그려지는 것과 정확한 렌더링을 

보장하는 합성이라는 작업이 필요하다. 합성이란 렌더 트리의 각 layer에서 계산된 px들을 최종 화면에 합치는 과정이다.
